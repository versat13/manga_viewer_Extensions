# Manga Double-page Spread Viewer - Chrome Extension

マンガなどの画像が縦一列に並んでいるサイトで機能する見開き型ビューア

## 機能

- **自動画像検出**: 複数の方法で画像を検出し、最適な方法を自動選択
- **見開き表示**: 2ページを並べて表示、日本語マンガに最適な右→左読み
- **単ページモード**: 1ページずつの表示も可能
- **多様な検出モード**: 
  - 自動検出（推奨）
  - スマート検出（リソースベース）
  - ディープスキャン（HTMLテキスト解析）
  - 基本検出（img タグ直接）
  - フレーム検出（iframe 内画像）
  - セレクタ検出（特定クラス内検索）
  - Canvas検出（ニコニコ静画等）
- **キーボード操作**: 矢印キー、スペースキーでページ送り
- **全画面表示**: フルスクリーン対応
- **背景色変更**: 黒・白背景の切り替え

## インストール方法

### 1. 拡張機能ファイルの準備

以下のファイルを同一フォルダに保存してください：

```
manga-viewer-extension/
├── manifest.json
├── content.js
├── popup.html
├── popup.js
├── icon16.png
├── icon48.png
└── icon128.png
```

### 2. アイコンファイルの準備

拡張機能用のアイコンファイル（PNG形式）を用意してください：
- `icon16.png` (16x16px)
- `icon48.png` (48x48px) 
- `icon128.png` (128x128px)

### 3. Chrome拡張機能として読み込み

1. Chromeで `chrome://extensions/` を開く
2. 右上の「デベロッパーモード」を有効にする
3. 「パッケージ化されていない拡張機能を読み込む」をクリック
4. 上記ファイルを保存したフォルダを選択

## 使用方法

### 基本操作

1. **自動起動**: マンガサイトで拡張機能アイコンをクリック→「ビューア起動」
2. **手動設定**: ポップアップで「ボタン表示」に設定すると、ページ右上に起動ボタンが表示

### ポップアップメニュー

拡張機能アイコンをクリックすると設定画面が開きます：

- **ビューア起動**: 現在のページでビューアを起動
- **検出テスト**: 各検出方法で見つかる画像数をテスト
- **サイト設定**: 起動ボタンの表示/非表示
- **検出モード設定**: 画像検出方法を手動選択
- **表示モード**: 単ページ/見開き切り替え

### キーボード操作

ビューア起動中に使用可能：

- `←` / `Space`: 次ページ
- `→`: 前ページ
- `↓` / `↑`: 単ページ送り
- `Esc`: ビューアを閉じる

## 対応サイト

基本的にあらゆるサイトで動作しますが、特に以下のような構造に最適化：

- `.reading-content` 内の画像
- `.chapter-content` 内の画像  
- `.manga-reader` 内の画像
- `.entry-content` 内の画像
- iframe 内の画像
- Canvas 要素（ニコニコ静画等）

## TamperMonkey版からの主な変更点

1. **GM_registerMenuCommand の削除**: メニューコマンドAPIは使用不可のため、ポップアップUIに移行
2. **Chrome Storage API**: `localStorage` の代わりに `chrome.storage.sync` を使用
3. **メッセージパッシング**: ポップアップとコンテンツスクリプト間の通信
4. **権限システム**: manifest.json で必要な権限を宣言

## トラブルシューティング

### 画像が検出されない場合

1. ポップアップで「検出テスト」を実行して、どの方法で画像が見つかるか確認
2. 検出モードを手動で変更（自動→スマート→ディープスキャン等）
3. 「全読込」ボタンでページ全体をスクロールして画像を読み込み
4. ページを少しスクロールしてから再度試行

### ビューアが起動しない場合

1. ページが完全に読み込まれてから実行
2. 他の拡張機能との競合を確認
3. コンソールエラーをチェック（F12→Console）
4. ページをリロードしてから再試行

### パフォーマンスの問題

1. 大量の画像があるページでは「全読込」を避ける
2. 検出モードを「基本型」に変更してリソース消費を削減
3. 単ページモードに切り替えて負荷を軽減

## 設定の詳細

### 検出モードの特徴

- **自動検出**: 全方法を試行、最も多く画像が見つかった方法を採用
- **スマート検出**: ブラウザのリソース情報から画像URLを取得、高速
- **ディープスキャン**: HTMLソースから正規表現で画像URLを抽出、網羅的
- **基本型**: DOM上のimg要素を直接検索、軽量
- **フレーム型**: iframe内の画像を検索、埋め込みコンテンツ対応
- **エリア型**: 特定のCSSクラス内の画像のみ検索、精度重視
- **Canvas型**: Canvas要素から画像を抽出、ニコニコ静画等に対応

### ストレージ使用について

設定は`chrome.storage.sync`に保存され、Chrome同期機能でデバイス間同期されます：

- サイト別の表示設定
- 検出モード設定  
- 単ページ/見開きモード設定
- ニコニコ静画の閾値設定

## 開発者向け情報

### ファイル構成

- `manifest.json`: 拡張機能の設定ファイル
- `content.js`: メインロジック、ページに注入されるスクリプト
- `popup.html/js`: 拡張機能ポップアップのUI
- `icon*.png`: 拡張機能アイコン

### 権限の説明

- `storage`: 設定の保存・読み込み
- `activeTab`: 現在のタブへのアクセス
- `host_permissions: "*://*/*"`: 全サイトでの動作許可

### カスタマイズ方法

`content.js`の`CONFIG`オブジェクトで動作を調整可能：

```javascript
const CONFIG = {
  minImageHeight: 400,        // 最小画像高さ
  minImageWidth: 200,         // 最小画像幅
  minMangaImageCount: 2,      // マンガ判定最小画像数
  refreshDebounceMs: 250,     // 更新処理の遅延時間
  autoDetectionInterval: 3000 // 自動検出の間隔
};
```

## ライセンス

MIT License

## 更新履歴

### v3.3.0
- TamperMonkey版からChrome拡張機能版に移植
- ポップアップUIによる設定管理
- Chrome Storage APIによる設定同期
- メッセージパッシングによるポップアップ連携

## サポート・バグ報告

問題が発生した場合は、以下の情報と共にご報告ください：

1. Chrome版本
2. 拡張機能バージョン
3. 問題が発生するURL
4. コンソールエラーメッセージ（F12で確認）
5. 再現手順
